<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Demoiselles cave</title>

	<link rel="stylesheet" type="text/css" href="./libs/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="./libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="./libs/spectrum/spectrum.js"></script>
	<script src="./libs/jquery-ui/jquery-ui.min.js"></script>


	<script src="./libs/other/BinaryHeap.js"></script>
	<script src="./libs/tween/tween.min.js"></script>
	<script src="./libs/d3/d3.js"></script>
	<script src="./libs/proj4/proj4.js"></script>
	<script src="./libs/openlayers3/ol.js"></script>
	<script src="./libs/i18next/i18next.js"></script>
	<script src="./libs/jstree/jstree.js"></script>
	<script src="./libs/potree/potree.js"></script>
	<script src="./libs/plasio/js/laslaz.js"></script>

	<div style="position: absolute;left:10px;top:10px;z-index: 10000;" id="divButtons">
		<button id="hq" type="check"
			style="width: 140px; height: 30px;border-radius: 5px;background-color: rgb(146, 146, 146);color: white;opacity: 75%;">Hight quality</button><br />
			<button id="edl" type="check"
			style="width: 140px; height: 30px;border-radius: 5px;background-color: rgb(146, 146, 146);color: white;opacity: 75%;">Eye-Dome Lighting</button><br /><br />
			
		<button id="save-state"
			style="width: 140px; height: 30px;border-radius: 5px;background-color: rgb(146, 146, 146);color: white;opacity: 75%;">Save</button><br />
		<button id="restore-state"
			style="width: 140px; height: 30px;border-radius: 5px;background-color: rgb(146, 146, 146);color: white;opacity: 75%;">Restore</button><br /><br />
	</div>

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area">
		</div>
		<div id="potree_sidebar_container"> </div>
	</div>

	<script type="module">
		import * as THREE from "./libs/three.js/build/three.module.js"

		const saveState = () => {
			const view = viewer.scene.view

			STATE.position = view.position.toArray()
			STATE.target = view.getPivot().toArray()

			console.log(STATE)
		}

		const goTo = (state) => {
			viewer.scene.view.position.set(...state.position)
			viewer.scene.view.lookAt(...state.target)
		}

		function connectButton(id, state) {
			document.getElementById(id).addEventListener('click', ev => {
				goTo(state)
			})
		}

		function createGotoButton(id, text, state) {
			const div = document.getElementById('divButtons')

			const button = document.createElement('button')
			button.textContent = text
			button.id = id
			button.style.width = '140px'
			button.style.height = '30px'
			button.style.borderRadius = '5px'
			button.style.backgroundColor = 'rgb(146, 146, 146)'
			button.style.color = 'white'
			button.style.opacity = '75%'
			div.appendChild(button)
			div.appendChild(document.createElement('br'))
			connectButton(id, state)
		}

		// ---------------------------------------------------------

		let viewer = undefined
		let scope = undefined

		const STATE = {
			target: [0, 0, 0],
			position: [0, 0, 0],
		}

		const VIRGIN = {
			target: [
				7.197289382358786,
				-9.242249321314699,
				141.31500012539794
			],
			position: [
				2.3150393792796056,
				-8.211927360720365,
				140.29569804191325
			]
		}

		const STAIRS = {
			target: [
				-2.7965513849211323,
				-22.026248250363984,
				153.07041474003427
			],
			position: [
				1.184863121913133,
				-5.395795777770388,
				156.8006225960302
			]
		}

		const EXIT = {
			target: [
				2.9812894382476722,
				-26.75124943256378,
				148.90099996280674
			],
			position: [
				2.2930519769275968,
				-21.930924809098006,
				150.5780964875626
			]
		}

		viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.setDescription("Cathedral of the Demoiselles cave (south of France). Courtesey of StÃ©phane Dominguez, CNRS")

		viewer.useHQ = true
		viewer.setEDLEnabled(true)
		viewer.setPointBudget(5000000)
		viewer.setBackground("black") // ["skybox", "gradient", "black", "white"];
		viewer.loadSettingsFromURL()
		viewer.toggleNavigationCube()

		document.getElementById('hq').addEventListener('click', _ => {
			viewer.useHQ = !viewer.useHQ
		})
		document.getElementById('edl').addEventListener('click', _ => {
			viewer.setEDLEnabled(!viewer.getEDLEnabled())
		})

		scope = viewer.controls

		// --------------------------------------------------

		document.getElementById('save-state').addEventListener('click', ev => {
			saveState()
		})
		connectButton('restore-state', STATE)

		createGotoButton('virgin', 'Go to virgin', VIRGIN)
		createGotoButton('stairs', 'Go to stairs', STAIRS)
		createGotoButton('exit', 'Go to exit door', EXIT)

		// --------------------------------------------------

		viewer.loadGUI().then(() => {
			viewer.setLanguage('en')
			$("#menu_appearance").next().show()
			$("#menu_tools").next().show()
			$("#menu_scene").next().show()
			document.getElementById('potree_quick_buttons').hidden = true
		});

		let url = "/data/metadata.json"

		Potree.loadPointCloud(url).then(e => {
			let pointcloud = e.pointcloud
			let material = pointcloud.material

			material.activeAttributeName = "rgba"
			material.minSize = 2
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE
			viewer.scene.addPointCloud(pointcloud)

		}).finally(_ => {
			viewer.fitToScreen()
		})

	</script>


</body>

</html>